<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=7; IE=EDGE">
	<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7" />
	<title>结算页</title>
	<link rel="stylesheet" href="/js/bootstrap3/css/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="/js/shop/css/webbase.css" />
	<link rel="stylesheet" type="text/css" href="/js/shop/css/pages-getOrderInfo.css" />
</head>

<body>
<div id="navDiv"></div>
<!--head-->
<div class="cart py-container" id="orderDiv">

	<!--主内容-->
	<div class="checkout py-container">
		<div class="checkout-steps">
			<!--收件人信息-->
			<div class="step-tit">
				<h5>收件人信息<span><a onclick="addInfo()">新增收货地址</a></span></h5>
			</div>
			<div class="step-cont">
				<div class="addressInfo">
					<ul class="addr-detail">
						<li class="addr-item" id="areaInfo">


						</li>


					</ul>

					<!--确认地址-->
				</div>
				<div class="hr"></div>

			</div>
			<div class="hr"></div>
			<!--支付和送货-->
			<div class="payshipInfo">
				<div class="step-tit">
					<h5>支付方式</h5>
				</div>
				<div class="step-cont">
					<input type="radio"  name="zfType" value="1">微信支付
					<input type="radio"  name="zfType" value="2">支付宝支付
					<input type="radio"  name="zfType" value="3">银行卡支付
				</div>
				<div class="hr"></div>
				<div class="step-tit">
					<h5>送货清单</h5>
				</div>
				<div class="step-cont">
					<ul class="send-detail" id="orderInfo">

					</ul>
				</div>
				<div class="hr"></div>
			</div>

		</div>
	</div>
	<div class="order-summary">
		<div class="static fr">
			<div class="list">
				<span><i class="number" id="totalcount"></i>件商品，总商品金额</span>
				<em class="allprice" id="totalprice"></em>
			</div>
			<div class="list">
				<span>返现：</span>
				<em class="money">0.00</em>
			</div>
			<div class="list">
				<span>运费：</span>
				<em class="transport">0.00</em>
			</div>
		</div>
	</div>
	<div class="clearfix trade">
		<div class="fc-price">应付金额:　<span class="price" id="totalprice2"></span></div>
		<div class="fc-receiverInfo" id="aa">寄送至:北京市海淀区三环内 中关村软件园9号楼 收货人：某某某 159****3201</div>
	</div>
	<div class="submit">
		<a class="sui-btn btn-danger btn-xlarge" onclick="addOrder()">提交订单</a>
	</div>
</div>


<div style="display: none" id="orderTem">
	<li>
		<div class="sendGoods">
			<ul class="yui3-g">
				<li class="yui3-u-1-6">
					<span><img src="##img##"/></span>
				</li>
				<li class="yui3-u-7-12">
					<div class="desc">##productName##</div>
					<div class="seven">7天无理由退货</div>
				</li>
				<li class="yui3-u-1-12">
					<div class="price">￥##price##</div>
				</li>
				<li class="yui3-u-1-12">
					<div class="num">X##count##</div>
				</li>
				<li class="yui3-u-1-12">
					<div class="exit">有货</div>
				</li>
			</ul>
		</div>
	</li>
</div>

<div style="display: none" id="qsorderTem">
	<li>
		<div class="sendGoods">
			<ul class="yui3-g">
				<li class="yui3-u-1-6">
					<span><img src="##img##"/></span>
				</li>
				<li class="yui3-u-7-12">
					<div class="desc">##productName##</div>
					<div class="seven">7天无理由退货</div>
				</li>
				<li class="yui3-u-1-12">
					<div class="price">￥##price##</div>
				</li>
				<li class="yui3-u-1-12">
					<div class="num">X##count##</div>
				</li>
				<li class="yui3-u-1-12">
					<div class="exit">缺货</div>
				</li>
			</ul>
		</div>
	</li>
</div>


<!-- 底部栏位 -->
<!--页面底部-->
<div class="clearfix footer">
	<div class="py-container">
		<div class="footlink">
			<div class="Mod-service">
				<ul class="Mod-Service-list">
					<li class="grid-service-item intro  intro1">

						<i class="serivce-item fl"></i>
						<div class="service-text">
							<h4>正品保障</h4>
							<p>正品保障，提供发票</p>
						</div>

					</li>
					<li class="grid-service-item  intro intro2">

						<i class="serivce-item fl"></i>
						<div class="service-text">
							<h4>正品保障</h4>
							<p>正品保障，提供发票</p>
						</div>

					</li>
					<li class="grid-service-item intro  intro3">

						<i class="serivce-item fl"></i>
						<div class="service-text">
							<h4>正品保障</h4>
							<p>正品保障，提供发票</p>
						</div>

					</li>
					<li class="grid-service-item  intro intro4">

						<i class="serivce-item fl"></i>
						<div class="service-text">
							<h4>正品保障</h4>
							<p>正品保障，提供发票</p>
						</div>

					</li>
					<li class="grid-service-item intro intro5">

						<i class="serivce-item fl"></i>
						<div class="service-text">
							<h4>正品保障</h4>
							<p>正品保障，提供发票</p>
						</div>

					</li>
				</ul>
			</div>
			<div class="clearfix Mod-list">
				<div class="yui3-g">
					<div class="yui3-u-1-6">
						<h4>购物指南</h4>
						<ul class="unstyled">
							<li>购物流程</li>
							<li>会员介绍</li>
							<li>生活旅行/团购</li>
							<li>常见问题</li>
							<li>购物指南</li>
						</ul>

					</div>
					<div class="yui3-u-1-6">
						<h4>配送方式</h4>
						<ul class="unstyled">
							<li>上门自提</li>
							<li>211限时达</li>
							<li>配送服务查询</li>
							<li>配送费收取标准</li>
							<li>海外配送</li>
						</ul>
					</div>
					<div class="yui3-u-1-6">
						<h4>支付方式</h4>
						<ul class="unstyled">
							<li>货到付款</li>
							<li>在线支付</li>
							<li>分期付款</li>
							<li>邮局汇款</li>
							<li>公司转账</li>
						</ul>
					</div>
					<div class="yui3-u-1-6">
						<h4>售后服务</h4>
						<ul class="unstyled">
							<li>售后政策</li>
							<li>价格保护</li>
							<li>退款说明</li>
							<li>返修/退换货</li>
							<li>取消订单</li>
						</ul>
					</div>
					<div class="yui3-u-1-6">
						<h4>特色服务</h4>
						<ul class="unstyled">
							<li>夺宝岛</li>
							<li>DIY装机</li>
							<li>延保服务</li>
							<li>品优购E卡</li>
							<li>品优购通信</li>
						</ul>
					</div>
					<div class="yui3-u-1-6">
						<h4>帮助中心</h4>
						<img src="img/wx_cz.jpg">
					</div>
				</div>
			</div>
			<div class="Mod-copyright">
				<ul class="helpLink">
					<li>关于我们<span class="space"></span></li>
					<li>联系我们<span class="space"></span></li>
					<li>关于我们<span class="space"></span></li>
					<li>商家入驻<span class="space"></span></li>
					<li>营销中心<span class="space"></span></li>
					<li>友情链接<span class="space"></span></li>
					<li>关于我们<span class="space"></span></li>
					<li>营销中心<span class="space"></span></li>
					<li>友情链接<span class="space"></span></li>
					<li>关于我们</li>
				</ul>
			</div>
		</div>
	</div>
</div>


<div style="display: none" id="addInfoDiv">

			<form class="form-horizontal">
				<div class="form-group">
					<label  class="col-sm-3 control-label">收货人</label>
					<div class="col-sm-4" >
						<input type="text" class="form-control"  placeholder="请输入收货人名..." id="memberName" >
					</div>
				</div>
				<div class="form-group">
					<label class="col-sm-3 control-label">手机号码</label>
					<div class="col-sm-4" >
						<div class="input-group">
							<input type="text" class="form-control" id="phone" placeholder="请输入手机号..." >

						</div>
					</div>
				</div>

				<div class="form-group"  id="sortSeleteDiv">
					<label  class="col-sm-3 control-label">地区</label>
				</div>

				<div class="form-group">
					<label class="col-sm-3 control-label">详细地址</label>
					<div class="col-sm-9" >
						<div class="input-group">
							<input type="text" class="form-control" id="info" placeholder="请输入详细地址...">

						</div>
					</div>
				</div>

				<div class="form-group">
					<label class="col-sm-3 control-label">设为默认地址</label>
					<div class="col-sm-4" >
						<div class="input-group">
							<input type="radio"  name="mrdz" value="1">是
							<input type="radio"  name="mrdz" value="0">否

						</div>
					</div>
				</div>
			</form>
</div>

<div style="display: none" id="updateInfoDiv">

	<form class="form-horizontal">
		<div class="form-group">
			<label  class="col-sm-3 control-label">收货人</label>
			<div class="col-sm-4" >
				<input type="text" class="form-control"  placeholder="请输入收货人名..." id="update_memberName" >
			</div>
		</div>
		<div class="form-group">
			<label class="col-sm-3 control-label">手机号码</label>
			<div class="col-sm-4" >
				<div class="input-group">
					<input type="text" class="form-control" id="update_phone" placeholder="请输入手机号..." >

				</div>
			</div>
		</div>

		<div class="form-group"  id="update_sortSeleteDiv">
			<label  class="col-sm-3 control-label">地区</label>
		</div>

		<div class="form-group">
			<label class="col-sm-3 control-label">详细地址</label>
			<div class="col-sm-9" >
				<div class="input-group">
					<input type="text" class="form-control" id="update_info" placeholder="请输入详细地址...">

				</div>
			</div>
		</div>

		<div class="form-group">
			<label class="col-sm-3 control-label">设为默认地址</label>
			<div class="col-sm-4" >
				<div class="input-group">
					<input type="radio"  name="update_mrdz" value="1">是
					<input type="radio"  name="update_mrdz" value="0">否

				</div>
			</div>
		</div>
	</form>
</div>

<div id="infoDiv" style="display: none">
	<div class="con name selected"><a href="javascript:" >##name##</a></div>
	<div class="con address">##name##  ##areaInfo## <span>##phone##</span>
		<span id="mr"></span>
		<a onclick="updateArea('##id##')" >编辑</a>&nbsp;&nbsp;<a href="#" onclick="deleteArea('##id##')">删除</a>
	</div>
	<div class="clearfix"></div>
</div>




<!--页面底部END-->
<script src="/js/jquery-3.3.1.js"></script>

<script type="text/javascript" src="/js/shop/js/plugins/jquery.easing/jquery.easing.min.js"></script>
<script type="text/javascript" src="/js/shop/js/plugins/sui/sui.min.js"></script>
<script type="text/javascript" src="/js/shop/components/ui-modules/nav/nav-portal-top.js"></script>
<script type="text/javascript" src="/js/shop/js/pages/getOrderInfo.js"></script>
<script src="/js/bootstrap3/js/bootstrap.min.js"></script>
<script src="/js/jquery.cookie.min.js"></script>
<script src="/js/bootbox/bootbox.min.js"></script>
<script src="/js/bootbox/bootbox.locales.min.js"></script>
<script src="/js/nav.js"></script>




<script>

	var infodiv;
	var updateinfodiv;
		$(function () {
			findCrat();
            findInfo();

            infodiv=$("#addInfoDiv").html();
            updateinfodiv=$("#updateInfoDiv").html();

		})
		function findCrat(){
			if (!loginFlag) {
				$("#orderDiv").html("<div style='text-align: center'><h1>还没有登录，请<a href='#' onclick='login_user()'>登陆</a>或者<a href=\"zhuce.html\">注册</a></h1></div>");
				return ;
			}
			$.ajax({
				type:"get",
				url:"http://localhost:8081/carts/findCart",
				success:function (res) {
					if(res.code==2102){
						location.href="/cart.html"
						return ;
					}else if(res.code==200){
						console.log(res.data)
						var v_cartHtml= $("#orderTem").html();
						var v_cart=res.data;
						var lists =v_cart.list;
						var resout="";
						for (var i=0;i<lists.length;i++) {
							var list=lists[i];
							resout+= v_cartHtml.replace(/##img##/g,list.mainImg)
								.replace(/##productName##/g,list.productName)
								.replace(/##price##/g,list.price)
								.replace(/##count##/g,list.subTotalCount)
								/*.replace(/##subtotalPrice##/g,list.subTotalPrice)
								.replace(/##id##/g,list.productId)*/

						}
						$("#orderInfo").html(resout)
						$("#totalcount").html(v_cart.totalCount);
						$("#totalprice").html("￥"+v_cart.toralPrice);
						$("#totalprice2").html("￥"+v_cart.toralPrice);
					}
				}
			})

		}

    var dialog;
   function addInfo(){
       initSortSelect(0);
       dialog=bootbox.dialog({
        title: '添加收货地址',
        message: $("#addInfoDiv form"),
        backdrop:false,
        buttons: {
            cancel: {
                label: "关闭",
                className: 'btn-danger',
            },
            confirm: {
                label: "确定",
                className: 'btn-primary',
                callback: function () {

                    var memberName = $("#memberName",dialog).val();
                    var phone = $("#phone",dialog).val();
                    var info = $("#info",dialog).val();
                    var mrdz = $("[name='mrdz']:checked",dialog).val();
                    var a1=$($("select[name='sortSelete']",dialog)[0]).val();
                    var a2=$($("select[name='sortSelete']",dialog)[1]).val();
                    var a3=$($("select[name='sortSelete']",dialog)[2]).val();

                    $.ajax({
                        url:"http://127.0.0.1:8081/shInfo",
                        data:{
                            "name":memberName,
                            "phone":phone,
                            "provinceId":a1,
                            "cityId":a2,
                            "countyId":a3,
                            "info":info,
                            "mrdz":mrdz,
                        },
                        type:"post",
                        success:function (res) {
                            if(res.code==200){
                                findInfo();
                            }else {
                                alert(res.msg)
                            }
                        }
                    })
                }
            }
        }
    });
    $("#addInfoDiv").html(infodiv)

}

        //地区
        function initSortSelect(id,obj) {
            if(obj){
                //找到父级div的同级元素删除
                $(obj).parent().nextAll().remove();
            }
            $.ajax({
                url: "http://127.0.0.1:8081/areas?id="+id,
                type: "get",
                success:function (result) {
                    if(result.code==200){
                        if(result.data.length==0){
                            return ;
                        }
                        //在指定的div追加select
                        var v_selete='<div class=\"col-sm-3\"><select class="form-control" name="sortSelete" onchange="initSortSelect(this.value,this)"><option value="-1">请选择</option>';
                        var sortArr=result.data;
                        for (var i = 0; i < sortArr.length; i++) {
                            v_selete+="<option value='"+sortArr[i].id+"' data-name="+sortArr[i].name+">"+sortArr[i].name+"</option>";
                        }
                        v_selete+="</select></div>";

                        $("#sortSeleteDiv",dialog).append(v_selete);

                    }
                }
            })
        }
    //修改地区
    function updateinitSortSelect(id,obj) {
        if(obj){
            //找到父级div的同级元素删除
            $(obj).parent().nextAll().remove();
        }
        $.ajax({
            url: "http://127.0.0.1:8081/areas?id="+id,
            type: "get",
            success:function (result) {
                if(result.code==200){
                    if(result.data.length==0){
                        return ;
                    }
                    //在指定的div追加select
                    var v_selete='<div class=\"col-sm-3\"><select class="form-control" name="updatesortSelete" onchange="updateinitSortSelect(this.value,this)"><option value="-1">请选择</option>';
                    var sortArr=result.data;
                    for (var i = 0; i < sortArr.length; i++) {
                        v_selete+="<option value='"+sortArr[i].id+"' data-name="+sortArr[i].name+">"+sortArr[i].name+"</option>";
                    }
                    v_selete+="</select></div>";

                    $("#update_sortSeleteDiv",dialog).append(v_selete);

                }
            }
        })
    }


    //收货人信息

	function findInfo(){
        $.ajax({
            url:"http://127.0.0.1:8081/shInfo",
            type:"get",
            success:function (res) {
                if(res.code==200){
					var v_info=$("#infoDiv").html();
					var data=res.data;
                    $("#areaInfo").html("")
					for (var i =0; i<data.length;i++) {

						var list = data[i];
						var v_areainfo = v_info.replace(/##name##/g,list.name)
							  .replace(/##phone##/g,list.phone)
							  .replace(/##areaInfo##/g,list.areaInfo)
							  .replace(/##id##/g,list.id);
						$("#areaInfo").append(v_areainfo)
					}
					if(data[0].mrdz==1){
                        $("#mr").html("<font color='red'>默认地址</font>")
					}

					$("#aa").html("寄送至："+data[0].areaInfo+"  收货人："+data[0].name+"  手机号："+data[0].phone)
                }else {
                    alert(res.msg)
                }
            }
        })
	}

	//删除
	function deleteArea(id){
        $.ajax({
            url:"http://127.0.0.1:8081/shInfo/"+id,
            type:"delete",
            success:function (res) {
                if(res.code==200){
                    findInfo();
                }else {
                    alert(res.msg)
                }
            }
        })
	}

	function token(){
        $.ajax({
            url:"http://127.0.0.1:8081/tokens",
            type:"get",
			async:false,
            success:function (res) {
                if(res.code==200){
                    $.cookie("x_token",res.data);
                }else {
                    alert(res.msg)
                }
            }
        })
	}


    //提交订单
    function addOrder(){
        token();
       var zfType=$("[name='zfType']:checked").val();
        $.ajax({
            url:"http://127.0.0.1:8081/orders",
            type:"post",
			data:{
                "zfType":zfType,
			},
            beforeSend:function(xhr){
                var header=$.cookie("x_token");
                xhr.setRequestHeader("x_token",header);
                var heades=$.cookie("fh_auth");
                xhr.setRequestHeader("x_auth",heades);
            },
            success:function (res) {
                if(res.code==200){
                    var lists=res.data;
                    var v_cartHtml=$("#qsorderTem").html();
                    var resout="";
                    if(lists.length>0){
                        for (var i=0;i<lists.length;i++){
                            var list=lists[i];
                            resout+= v_cartHtml.replace(/##img##/g,list.mainImg)
                                .replace(/##productName##/g,list.productName)
                                .replace(/##price##/g,list.price)
                                .replace(/##count##/g,list.subTotalCount)
						}
                        var info=$("#qsorderTem").html(resout)
                        dialog=bootbox.dialog({
                            title: '缺货信息提示',
                            message: resout,
                            backdrop:false,
                            buttons: {
                                confirm: {
                                    label: "确定",
                                    className: 'btn-primary',
                                    callback: function () {
                                        location.href="/pay.html"
                                    }
                                }
                            }
                        });
					}else {
                        location.href="/pay.html"
					}


                }else {
                    alert(res.msg)
                }
            }
        })
    }


    //修改地址
var v_areaName;
	function  updateArea(id){
        $.ajax({
            url:"http://127.0.0.1:8081/shInfo/byId?id="+id,
            type:"get",
            success:function (res) {
                if(res.code==200){
                    var data=res.data;
                    v_areaName=data.areaInfo;
                    $("#update_memberName").val(data.name);
                    $("#update_phone").val(data.phone);
                     $("#update_info").val(data.info);
                     $("#update_sortSeleteDiv").append("<div>"+data.areaInfo+"<button class=\"btn btn-primary\" onclick=\"by(this)\"><i class=\"glyphicon glyphicon-pencil\"></i>编辑</button></div>");
                     $("[name='update_mrdz']").each(function () {
						 if(this.value==data.mrdz){
                             this.checked=true;
						 }
                     })

                    dialog=bootbox.dialog({
                        title: '添加收货地址',
                        message: $("#updateInfoDiv form"),
                        backdrop:false,
                        buttons: {
                            cancel: {
                                label: "关闭",
                                className: 'btn-danger',
                            },
                            confirm: {
                                label: "确定",
                                className: 'btn-primary',
                                callback: function () {

                                    var memberName = $("#update_memberName",dialog).val();
                                    var phone = $("#update_phone",dialog).val();
                                    var info = $("#update_info",dialog).val();
                                    var mrdz = $("[name='update_mrdz']:checked",dialog).val();
                                    var a1=$($("select[name='update_sortSelete']",dialog)[0]).val();
                                    var a2=$($("select[name='update_sortSelete']",dialog)[1]).val();
                                    var a3=$($("select[name='update_sortSelete']",dialog)[2]).val();

                                    $.ajax({
                                        url:"http://127.0.0.1:8081/shInfo",
                                        data:{
                                            "name":memberName,
                                            "phone":phone,
                                            "provinceId":a1,
                                            "cityId":a2,
                                            "countyId":a3,
                                            "info":info,
                                            "mrdz":mrdz,
                                        },
                                        type:"post",
                                        success:function (res) {
                                            if(res.code==200){
                                                findInfo();
                                            }else {
                                                alert(res.msg)
                                            }
                                        }
                                    })
                                }
                            }
                        }
                    });
                    $("#updateInfoDiv").html(updateinfodiv);

                }else {
                    alert(res.msg)
                }
            }
        })

	}


    //编辑
    function by(obj){
        //清除
        $(obj).parent().remove();

        //往后拼接
        updateinitSortSelect(0);
        $("#update_sortSeleteDiv",dialog).append('<button class="btn btn-primary" onclick="qx()"><i class="glyphicon glyphicon-pencil"></i>取消编辑</button>');
    }
    function qx() {
        $("#update_sortSeleteDiv",dialog).html("<label  class=\"col-sm-3 control-label\">地区</label><div>" + v_areaName + "<button class=\"btn btn-primary\" onclick=\"by(this)\"><i class=\"glyphicon glyphicon-pencil\"></i>编辑</button></div>")
    }

</script>

</body>
</html>